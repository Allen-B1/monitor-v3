<html>
    <head>
        <title>Monitor - {self.name}</title>
        <!--{#-->
        <style>
                body {
                    font-family: sans-serif;
                    font-size: 14px;
                    margin: 0; padding: 0; }
                header {
                    background: hsl(45, 70%, 50%);
                    color: #fff;
                    display: flex;
                    flex-direction: row;
                    padding: 16px; }
                header h1, header p {
                    margin: 0;
                    font-size: 16px;
                }
                header h1 {
                    flex-grow: 1;
                }

                #subheader {
                    padding: 8px 16px;
                    display: flex;
                    flex-direction: row; }
                #subheader form {
                    text-align: center;
                    flex-grow: 1;
                    margin: 0; }

                input, button, .button, select {
                    border: 2px solid hsl(45, 70%, 50%);
                    padding: 7px 16px;
                    font-family: sans-serif;
                    font-size: 14px;
                    background: #fff;
                    text-decoration: none;
                }
                button, .button, select {
                    color: #fff;
                    background: hsl(45, 70%, 50%);
                    padding: 8px 16px;
                    border: none;
                }
                button:active, select:active, .button:active {
                    background: hsl(45, 70%, 40%);
                }

                .program {
                    padding: 8px 16px;
                    display: flex;
                    flex-direction: row;
                    align-items: center; }
                .program-name {
                    padding-top: 4px;
                    align-self: flex-start;
                    font-size: 16px;
                    text-align: left;
                    flex-basis: 192px;
                    margin-right: 8px; }
                .program-bars {
                    flex-grow: 1; }
                .program-time {
                    font-size: 12px;
                    margin-bottom: 2px;
                    color: #aaa; }
                    .program-time-active {
                        color: hsl(45, 70%, 50%); }
                .program:not(.program-sub) {
                    border-top: 1px solid #aaa;
                }

                .program-bar {
                    margin-bottom: 6px;
                    height: 4px;
                    background: #ccc;
                    width: var(--percent); }
                    .program-bar-active {
                        background: hsl(45, 70%, 50%); }

                .program-Firefox .program-bar-active {
                    background: hsl(30, 75%, 50%); }
                .program-Firefox .program-time-active {
                    color: hsl(30, 75%, 50%); }
        </style>
        <!--}-->
    </head>
    <body>
        <header>
            <h1>{self.name}'s Activity</h1>
            <p>{self.date.format("%Y-%m-%d")}</p>
        </header>
        <div id="subheader">
            <a class="button" href="/{self.name}/{(self.date + chrono::Duration::days(-1)).format("%Y/%m/%d")}/{self.device}/">&lt;</a>

            <form method="GET" action="/{self.name}/redirect">
                <select name="device" required>
                {:for (id, data) in self.devices.iter()}
                    <option {:if *id == self.device}selected{:end} value="{id}">{data}</option>
                {:end}
                </select>
                <input type="date" name="date" value="{self.date.format("%Y-%m-%d")}" required>
                <button type="submit">Go</button>
            </form>

            <a class="button" href="/{self.name}/{(self.date + chrono::Duration::days(1)).format("%Y/%m/%d")}/{self.device}/">&gt;</a>
        </div>

        {:fn format_class(s: &str) -> String {
            s.replace(" ", "_").to_lowercase()
        }}

        {:fn format_duration(secs: u32) -> String {
            let minutes = secs / 60;
            let hours = minutes / 60;

            let mut s = String::new();
            if hours > 0 {
                s += &format!("{}h", hours);
            }
            if hours > 0 || minutes > 0 {
                s += &format!("{}m", minutes % 60);
            }
            s += &format!("{}s", secs % 60);
            s
        }}

        <main>
        {:let max_time = std::cmp::max(60 * 60 * 2, self.monitor.open.iter().max_by_key(|(prg, &time)| -> u32 {time}).map(|(_, &time)| time).unwrap())}
        {:let mut program_order: Vec<_> = self.monitor.open.keys().collect()}
        {: program_order.sort_by(|a, b| self.active_data.get(&b.program).map(|x| x.0).unwrap_or(0).partial_cmp(&self.active_data.get(&a.program).map(|x| x.0).unwrap_or(0)).unwrap()) }
        {:for prg in program_order.iter()}
            {:let time = self.monitor.open[prg]}
            <div class="program program--{format_class(&prg.program)}">
                <div class="program-name">{prg.program}</div>
                <div class="program-bars">
                    {:if self.active_data.contains_key(&prg.program)}
                        {:let active_time = self.active_data[&prg.program].0}
                        <div class="program-time program-time-active">{format_duration(active_time)}</div>
                        <div class="program-bar program-bar-active" style="--percent: {(active_time as f64) / (max_time as f64) * 100.0}%"></div>
                    {:end}
                    <div class="program-time program-time-open">{format_duration(time)}</div>
                    <div class="program-bar" style="--percent: {(time as f64) / (max_time as f64) * 100.0}%"></div>
                </div>
            </div>

            {:if self.active_data.contains_key(&prg.program)}
            {:for subprogram in self.active_data[&prg.program].1.iter()}
                {:let active_time = self.monitor.active[&monitor::ActiveProgram { program: prg.program.clone(), subprogram: Some(subprogram.clone()) }]}
                <div class="program program-sub program--{format_class(&prg.program)}">
                    <div class="program-name">{subprogram}</div>
                    <div class="program-bars">
                        <div class="program-time program-time-active">{format_duration(active_time)}</div>
                        <div class="program-bar program-bar-active" style="--percent: {(active_time as f64) / (max_time as f64) * 100.0}%"></div>
                    </div>
                </div>
            {:end}
            {:end}
        {:end}
        </main>
    </body>
</html>